<!DOCTYPE html>
<html>
<head>
    <title>Place Order ‚Äì ChocoBrownie</title>
    <style>
        body { 
            font-family: Arial; 
            padding: 20px;
        }
        .item-row {
            margin-bottom: 12px;
            padding: 10px;
            border-radius: 8px;
            background: #f2f2f2;
        }
        .qty-box {
            width: 60px;
            padding: 5px;
            font-size: 16px;
            margin-left: 10px;
        }
        button { 
            padding: 10px 15px; 
            margin-top: 15px;
            font-size: 18px;
            background: #4CAF50;
            color: #fff;
            border: none;
            border-radius: 6px;
        }
        #totalView {
            font-weight: bold;
            font-size: 20px;
            margin-top: 20px;
        }
    </style>

    <!-- Load API -->
    <script type="module">
        import { apiGet, apiPost } from "./js/api.v2.js?v=3";
        window.apiGet = apiGet;
        window.apiPost = apiPost;
    </script>
</head>

<body>

<h1>üç´ Place Your Order</h1>

<div id="menu"></div>

<h2>Your Details</h2>
<input id="name" placeholder="Your Name"><br><br>
<input id="phone" placeholder="Phone Number"><br><br>

<div id="totalView">Total: ‚Çπ0</div>

<button onclick="submitOrder()">Submit Order</button>

<script>
let menuData = [];

// Load menu
window.onload = async () => {
    menuData = await apiGet({ action: "getmenu" });

    const menuDiv = document.getElementById("menu");

    menuData.forEach((item, idx) => {
        menuDiv.innerHTML += `
            <div class="item-row">
                <b>${item.name}</b> ‚Äì ‚Çπ${item.price}
                <input type="number" class="qty-box" id="qty_${idx}" min="0" value="0" oninput="updateTotal()">
            </div>
        `;
    });
};

// Update total
function updateTotal() {
    let total = 0;

    menuData.forEach((item, idx) => {
        let qty = Number(document.getElementById("qty_" + idx).value);
        if (qty > 0) total += item.price * qty;
    });

    document.getElementById("totalView").innerText = "Total: ‚Çπ" + total;
}

// Submit order
async function submitOrder() {
    const name = document.getElementById("name").value.trim();
    const phone = document.getElementById("phone").value.trim();

    if (!name || !phone) {
        alert("Please enter name and phone");
        return;
    }

    let selected = [];
    let total = 0;

    menuData.forEach((item, idx) => {
        const qty = Number(document.getElementById("qty_" + idx).value);

        if (qty > 0) {
            selected.push({
                name: item.name,
                price: item.price,
                qty: qty
            });
            total += item.price * qty;
        }
    });

    if (selected.length === 0) {
        alert("Please select at least one item.");
        return;
    }

    const items_json = JSON.stringify(selected);

    const res = await apiPost({
        action: "createorder",
        name,
        phone,
        items_json,
        total: String(total)
    });

    if (res.error) {
        alert("Error: " + res.error);
    } else {
        // ‚≠ê SAVE CUSTOMER PHONE FOR TOKEN TRACKING
        localStorage.setItem("myPhone", phone);

        alert("Order received! Please wait for staff approval to get your token.");
        window.location.href = "mytoken.html";
    }
}
</script>


</body>
</html>
