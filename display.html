<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Now Serving ‚Äì ChocoBrownie</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; text-align:center; background:#f8f8f8; padding-top:40px; }
    .box { background:#fff; width:420px; margin:20px auto; padding:34px; border-radius:16px; box-shadow:0 6px 20px rgba(0,0,0,0.08); }
    h1 { font-size:46px; margin:6px 0 18px; }
    .label { font-size:20px; color:#555; margin-top:10px; }
    .value { font-size:56px; font-weight:700; color:#c9372c; margin:6px 0 14px; letter-spacing:1px; }
    .info { font-size:16px; color:#666; margin-top:8px; }
    .small { font-size:13px; color:#999; margin-top:8px; }
    .err { color:#b12; font-weight:600; }
  </style>

  <!-- DO NOT use meta refresh; we use JS polling for better error handling -->
  <script type="module">
    import { apiGet } from "./js/api.v2.js";

    // sanitize and display numeric value (if not a number, show fallback)
    function showNumber(elId, val, fallback="-") {
      if (val === undefined || val === null || val === "") {
        document.getElementById(elId).innerText = fallback;
        return;
      }
      const n = Number(val);
      if (Number.isFinite(n)) document.getElementById(elId).innerText = n;
      else document.getElementById(elId).innerText = String(val);
    }

    // main loader with retry
    let failingCount = 0;
    async function loadStatus() {
      try {
        const status = await apiGet({ action: "getstatus" });

        // GAS should return { session_id, currentToken, lastTokenIssued, queueLength }
        // handle error object from GAS/proxy
        if (status && status.error) {
          console.warn("GAS error:", status);
          document.getElementById("err").innerText = status.error;
          failingCount++;
          return;
        } else {
          document.getElementById("err").innerText = "";
        }

        // show results (stable)
        showNumber("current", status.currentToken ?? "-", "-");
        showNumber("last", status.lastTokenIssued ?? "-", "-");
        showNumber("queue", status.queueLength ?? 0, "0");

        // session id (show dash if missing)
        document.getElementById("session").innerText = status.session_id || "-";

        failingCount = 0;
      } catch (err) {
        console.error("loadStatus error:", err);
        document.getElementById("err").innerText = "Network error. See console.";
        failingCount++;
      } finally {
        // if repeated failures, poll slower to avoid extra load
        const delay = failingCount >= 5 ? 5000 : 2000; // ms
        setTimeout(loadStatus, delay);
      }
    }

    // start polling when page ready
    window.addEventListener("DOMContentLoaded", () => {
      loadStatus();
    });
  </script>
</head>
<body>
  <h1>üç´ ChocoBrownie</h1>

  <div class="box">
    <div class="label">NOW SERVING</div>
    <div id="current" class="value">-</div>

    <div class="label">LAST TOKEN ISSUED</div>
    <div id="last" class="value">-</div>

    <div class="label">PEOPLE IN QUEUE</div>
    <div id="queue" class="value">-</div>

    <div class="info">
      Session: <span id="session">-</span>
    </div>

    <div id="err" class="small err"></div>
    <div class="small">Auto-updates every 2s. If numbers are blank, open the browser console (F12 ‚Üí Network) to inspect /api/proxy?action=getstatus</div>
  </div>
</body>
</html>
