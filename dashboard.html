<!DOCTYPE html>
<html>
<head>
    <title>Staff Dashboard</title>

    <!-- Load API as ES Module -->
    <script type="module">
        import { apiGet, apiPost } from "./js/api.js";
        window.apiGet = apiGet;
        window.apiPost = apiPost;
    </script>

    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f4f4f4;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            background: white;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 10px;
        }
        th { background: #ddd; }
        button { padding: 8px 12px; cursor: pointer; }
    </style>
</head>
<body>

<h1>Staff Dashboard</h1>

<!-- SESSION BUTTON -->
<button onclick="startSession()">Start New Session</button>

<!-- TOKEN CONTROLS -->
<h2>Token Controls</h2>
<button onclick="nextToken()">Next Token</button>
<button onclick="setToken()">Set Token</button>

<h2>Orders (Current Session)</h2>

<table id="ordersTable">
    <thead>
        <tr>
            <th>#</th>
            <th>Name</th>
            <th>Phone</th>
            <th>Items</th>
            <th>Total</th>
            <th>Status</th>
            <th>Token</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<script>
// Load orders when page opens
window.onload = loadOrders;

// Fetch orders from API
async function loadOrders() {
    try {
        const data = await apiGet({ action: "getorders" });
        console.log("Orders received:", data);

        const table = document.querySelector("#ordersTable tbody");
        table.innerHTML = "";

        data.forEach((order, i) => {
            const index = i + 2; // Row index in sheet

            table.innerHTML += `
                <tr>
                    <td>${i + 1}</td>
                    <td>${order.name}</td>
                    <td>${order.phone}</td>
                    <td>${order.items_json}</td>
                    <td>${order.total}</td>
                    <td>${order.status}</td>
                    <td>${order.token || "-"}</td>
                    <td>
                        ${order.status === "pending"
                            ? `<button onclick="approveOrder(${index})">Approve</button>`
                            : "âœ”"}
                    </td>
                </tr>
            `;
        });

    } catch (err) {
        console.error("Error loading orders", err);
        alert("Failed to load orders");
    }
}

// Approve order
async function approveOrder(rowIndex) {
    const pwd = prompt("Enter staff password:");
    if (!pwd) return;

    const res = await apiPost({
        action: "approveorder",
        rowIndex,
        staff_password: pwd
    });

    if (res.error) alert(res.error);
    else alert("Assigned Token: " + res.token);

    loadOrders();
}

// Start session
async function startSession() {
    const pwd = prompt("Password:");
    if (!pwd) return;

    const res = await apiPost({
        action: "newsession",
        staff_password: pwd
    });

    alert("Session Started: " + res.session_id);
    loadOrders();
}

// Next token
async function nextToken() {
    const pwd = prompt("Password:");
    if (!pwd) return;

    const res = await apiPost({
        action: "updatetoken",
        action2: "next",
        staff_password: pwd
    });

    alert("Serving Token: " + res.currentToken);
}

// Set token
async function setToken() {
    const pwd = prompt("Password:");
    if (!pwd) return;

    const num = prompt("Enter token:");
    if (!num) return;

    const res = await apiPost({
        action: "updatetoken",
        action2: "set",
        value: num,
        staff_password: pwd
    });

    alert("Token Set: " + res.currentToken);
}
</script>

</body>
</html>
